-- Roblox Dark GUI Library
-- Версия с нормальным драггингом и улучшенными элементами

local OrionLib = {}

-- Настройки
OrionLib.WindowCount = 0
OrionLib.MaxWindows = 5

-- Сервисы
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

-- Утилиты
function OrionLib:Create(className, properties)
    local instance = Instance.new(className)
    for property, value in pairs(properties) do
        instance[property] = value
    end
    return instance
end

-- Создание окна
function OrionLib:MakeWindow(options)
    if OrionLib.WindowCount >= OrionLib.MaxWindows then
        warn("Максимальное количество окон достигнуто (" .. OrionLib.MaxWindows .. ")")
        return nil
    end
    
    OrionLib.WindowCount += 1
    local Window = {}
    
    -- Создание ScreenGui
    local ScreenGui = OrionLib:Create("ScreenGui", {
        Name = "DarkGUI",
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        DisplayOrder = 999
    })
    
    -- Главный контейнер окна
    local MainFrame = OrionLib:Create("Frame", {
        Name = "MainFrame",
        Size = UDim2.new(0, 125, 0, 25),
        Position = UDim2.new(0, 15 + ((OrionLib.WindowCount - 1) * 140), 0, 15),
        BackgroundColor3 = Color3.fromRGB(30, 30, 30),
        BorderSizePixel = 0,
        ClipsDescendants = true,
        Parent = ScreenGui
    })
    
    -- НОРМАЛЬНЫЙ ДРАГГИНГ: Заголовок окна с улучшенным Input
    local TitleBar = OrionLib:Create("TextButton", {
        Name = "TitleBar",
        Size = UDim2.new(1, 0, 0, 25),
        BackgroundColor3 = Color3.fromRGB(40, 40, 40),
        BorderSizePixel = 0,
        Text = "",
        AutoButtonColor = false,
        Parent = MainFrame
    })
    
    -- Текст заголовка
    local TitleText = OrionLib:Create("TextLabel", {
        Name = "TitleText",
        Size = UDim2.new(1, -30, 1, 0),
        Position = UDim2.new(0, 5, 0, 0),
        BackgroundTransparency = 1,
        Text = options.Name or "Window",
        TextColor3 = Color3.fromRGB(220, 220, 220),
        TextXAlignment = Enum.TextXAlignment.Left,
        Font = Enum.Font.Gotham,
        TextSize = 13,
        Parent = TitleBar
    })
    
    -- Кнопка сворачивания (БЕЗ ПОДЛОЖКИ)
    local ToggleButton = OrionLib:Create("TextButton", {
        Name = "ToggleButton",
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(1, -25, 0, 2),
        BackgroundTransparency = 1,
        Text = "+",
        TextColor3 = Color3.fromRGB(220, 220, 220),
        Font = Enum.Font.GothamBold,
        TextSize = 16,
        Parent = TitleBar
    })
    
    -- Контейнер для элементов
    local Container = OrionLib:Create("Frame", {
        Name = "Container",
        Size = UDim2.new(1, 0, 1, -25),
        Position = UDim2.new(0, 0, 0, 25),
        BackgroundColor3 = Color3.fromRGB(25, 25, 25),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        Parent = MainFrame
    })
    
    local ContainerList = OrionLib:Create("UIListLayout", {
        Parent = Container,
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 5)
    })
    
    local ContainerPadding = OrionLib:Create("UIPadding", {
        Parent = Container,
        PaddingTop = UDim.new(0, 5),
        PaddingLeft = UDim.new(0, 5),
        PaddingRight = UDim.new(0, 5)
    })
    
    -- Состояния
    Window.Closed = true
    Window.Elements = {}
    
    -- Функция переключения
    function Window:Toggle()
        Window.Closed = not Window.Closed
        
        if Window.Closed then
            ToggleButton.Text = "+"
            TweenService:Create(MainFrame, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 125, 0, 25)
            }):Play()
            Container.Visible = false
        else
            ToggleButton.Text = "-"
            -- Вычисляем высоту контейнера
            local totalHeight = 25
            for _, element in pairs(Window.Elements) do
                totalHeight = totalHeight + element.Size.Y.Offset
            end
            TweenService:Create(MainFrame, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 125, 0, totalHeight)
            }):Play()
            Container.Visible = true
        end
    end
    
    -- Обработчик кнопки
    ToggleButton.MouseButton1Click:Connect(function()
        Window:Toggle()
    end)
    
    -- НОРМАЛЬНЫЙ ДРАГГИНГ
    local isDragging = false
    local dragStart = nil
    local startPosition = nil
    
    -- Начало перетаскивания
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            dragStart = input.Position
            startPosition = MainFrame.Position
            
            -- Эффект при захвате
            TweenService:Create(TitleBar, TweenInfo.new(0.1), {
                BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            }):Play()
        end
    end)
    
    -- Изменение ввода (движение мыши)
    TitleBar.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(
                startPosition.X.Scale, 
                startPosition.X.Offset + delta.X,
                startPosition.Y.Scale, 
                startPosition.Y.Offset + delta.Y
            )
        end
    end)
    
    -- Конец перетаскивания
    TitleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
            TweenService:Create(TitleBar, TweenInfo.new(0.1), {
                BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            }):Play()
        end
    end)
    
    -- Методы для добавления элементов
    function Window:AddButton(name, callback)
        local ButtonFrame = OrionLib:Create("Frame", {
            Name = name .. "Button",
            Size = UDim2.new(1, 0, 0, 30),
            BackgroundColor3 = Color3.fromRGB(40, 40, 40),
            BorderSizePixel = 0,
            Parent = Container
        })
        
        -- ЗАКРУГЛЕННЫЕ УГЛЫ ДЛЯ КНОПКИ
        OrionLib:Create("UICorner", {
            CornerRadius = UDim.new(0, 6),
            Parent = ButtonFrame
        })
        
        local ButtonLabel = OrionLib:Create("TextLabel", {
            Name = "Label",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = name,
            TextColor3 = Color3.fromRGB(220, 220, 220),
            Font = Enum.Font.Gotham,
            TextSize = 13,
            Parent = ButtonFrame
        })
        
        local ButtonBtn = OrionLib:Create("TextButton", {
            Name = "Button",
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = "",
            Parent = ButtonFrame
        })
        
        -- Эффекты наведения для кнопки
        ButtonBtn.MouseEnter:Connect(function()
            TweenService:Create(ButtonFrame, TweenInfo.new(0.2), {
                BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            }):Play()
        end)
        
        ButtonBtn.MouseLeave:Connect(function()
            TweenService:Create(ButtonFrame, TweenInfo.new(0.2), {
                BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            }):Play()
        end)
        
        ButtonBtn.MouseButton1Click:Connect(function()
            if callback then 
                -- Эффект нажатия
                TweenService:Create(ButtonFrame, TweenInfo.new(0.1), {
                    BackgroundColor3 = Color3.fromRGB(60, 60, 60)
                }):Play()
                task.wait(0.1)
                TweenService:Create(ButtonFrame, TweenInfo.new(0.1), {
                    BackgroundColor3 = Color3.fromRGB(40, 40, 40)
                }):Play()
                callback() 
            end
        end)
        
        table.insert(Window.Elements, ButtonFrame)
        return ButtonFrame
    end
    
    function Window:AddToggle(name, default, callback)
        local Toggle = {Value = default or false}
        
        local ToggleFrame = OrionLib:Create("Frame", {
            Name = name .. "Toggle",
            Size = UDim2.new(1, 0, 0, 25),
            BackgroundTransparency = 1,
            Parent = Container
        })
        
        local ToggleLabel = OrionLib:Create("TextLabel", {
            Name = "Label",
            Size = UDim2.new(1, -45, 1, 0),
            BackgroundTransparency = 1,
            Text = name,
            TextColor3 = Color3.fromRGB(220, 220, 220),
            TextXAlignment = Enum.TextXAlignment.Left,
            Font = Enum.Font.Gotham,
            TextSize = 12,
            Parent = ToggleFrame
        })
        
        -- КВАДРАТИК ДЛЯ ТОГГЛА
        local ToggleButton = OrionLib:Create("TextButton", {
            Name = "ToggleBtn",
            Size = UDim2.new(0, 25, 0, 25),  -- Квадрат 25x25
            Position = UDim2.new(1, -25, 0, 0),
            BackgroundColor3 = Toggle.Value and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(70, 70, 70),  -- Зеленый/серый
            BorderSizePixel = 0,
            Text = "",
            Parent = ToggleFrame
        })
        
        -- Скругления для квадратика (немного, чтобы не острый)
        OrionLib:Create("UICorner", {
            CornerRadius = UDim.new(0, 4),
            Parent = ToggleButton
        })
        
        function Toggle:Set(value)
            Toggle.Value = value
            TweenService:Create(ToggleButton, TweenInfo.new(0.2), {
                BackgroundColor3 = value and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(70, 70, 70)
            }):Play()
            if callback then callback(value) end
        end
        
        -- Эффекты наведения для тоггла
        ToggleButton.MouseEnter:Connect(function()
            if not Toggle.Value then
                TweenService:Create(ToggleButton, TweenInfo.new(0.2), {
                    BackgroundColor3 = Color3.fromRGB(90, 90, 90)
                }):Play()
            end
        end)
        
        ToggleButton.MouseLeave:Connect(function()
            if not Toggle.Value then
                TweenService:Create(ToggleButton, TweenInfo.new(0.2), {
                    BackgroundColor3 = Color3.fromRGB(70, 70, 70)
                }):Play()
            end
        end)
        
        ToggleButton.MouseButton1Click:Connect(function()
            Toggle:Set(not Toggle.Value)
        end)
        
        table.insert(Window.Elements, ToggleFrame)
        return Toggle
    end
    
    function Window:AddLabel(text)
        local Label = OrionLib:Create("TextLabel", {
            Name = "Label",
            Size = UDim2.new(1, 0, 0, 20),
            BackgroundTransparency = 1,
            Text = text,
            TextColor3 = Color3.fromRGB(180, 180, 180),
            TextXAlignment = Enum.TextXAlignment.Left,
            Font = Enum.Font.Gotham,
            TextSize = 12,
            Parent = Container
        })
        
        table.insert(Window.Elements, Label)
        return Label
    end
    
    -- Помещаем GUI
    ScreenGui.Parent = CoreGui
    
    return Window
end

return OrionLib
