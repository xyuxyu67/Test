--// Custom UI Library (FIXED)

local Library = {}
Library.Windows = {}
Library.MaxWindows = 5

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local PlayerGui = Players.LocalPlayer:WaitForChild("PlayerGui")

-- ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomUILibrary"
ScreenGui.ResetOnSpawn = false
ScreenGui.DisplayOrder = 1000000
ScreenGui.Parent = PlayerGui

-- CONSTANTS
local WINDOW_WIDTH = 135
local WINDOW_HEIGHT = 200
local MIN_HEIGHT = 28
local SPACING = 8
local TOP_OFFSET = 15
local TWEEN_TIME = 0.06

local TOPBAR_COLOR = Color3.fromRGB(130,130,130)
local BODY_COLOR = Color3.fromRGB(163,163,163)

-- Window positioning
local function UpdatePositions()
	for i, win in ipairs(Library.Windows) do
		win.Main.Position = UDim2.new(
			0, SPACING + (i - 1) * (WINDOW_WIDTH + SPACING),
			0, TOP_OFFSET
		)
	end
end

-- DRAG SYSTEM (НОРМАЛЬНЫЙ)
local function MakeDraggable(frame, handle)
	local dragging = false
	local dragStart
	local startPos

	handle.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(
				startPos.X.Scale,
				startPos.X.Offset + delta.X,
				startPos.Y.Scale,
				startPos.Y.Offset + delta.Y
			)
		end
	end)
end

-- CREATE WINDOW
function Library:CreateWindow(config)
	if #Library.Windows >= Library.MaxWindows then return end
	config = config or {}

	local Name = config.Name or "Window"
	local Font = config.Font or Enum.Font.Legacy

	-- MAIN
	local Main = Instance.new("Frame")
	Main.Size = UDim2.fromOffset(WINDOW_WIDTH, WINDOW_HEIGHT)
	Main.BackgroundColor3 = BODY_COLOR
	Main.BorderSizePixel = 0
	Main.ZIndex = 10
	Main.Parent = ScreenGui

	-- TOPBAR
	local TopBar = Instance.new("Frame")
	TopBar.Size = UDim2.fromOffset(WINDOW_WIDTH, MIN_HEIGHT)
	TopBar.BackgroundColor3 = TOPBAR_COLOR
	TopBar.BorderSizePixel = 0
	TopBar.ZIndex = 11
	TopBar.Parent = Main

	-- TITLE
	local Title = Instance.new("TextLabel")
	Title.Size = UDim2.new(1, -24, 1, 0)
	Title.Position = UDim2.fromOffset(6, 0)
	Title.BackgroundTransparency = 1
	Title.Text = Name
	Title.TextColor3 = Color3.new(1,1,1)
	Title.Font = Font
	Title.TextScaled = true
	Title.TextXAlignment = Enum.TextXAlignment.Left
	Title.TextYAlignment = Enum.TextYAlignment.Center
	Title.ZIndex = 12
	Title.Parent = TopBar

	-- MINIMIZE (ДЛИННЫЙ МИНУС)
	local Min = Instance.new("TextButton")
	Min.Size = UDim2.fromOffset(18, 18)
	Min.Position = UDim2.new(1, -20, 0.5, -9)
	Min.BackgroundTransparency = 1
	Min.Text = "–"
	Min.TextColor3 = Color3.new(1,1,1)
	Min.Font = Font
	Min.TextScaled = true
	Min.ZIndex = 12
	Min.Parent = TopBar

	-- WINDOW OBJECT
	local Window = {
		Main = Main,
		Minimized = false
	}

	function Window:Toggle()
		Window.Minimized = not Window.Minimized

		TweenService:Create(
			Main,
			TweenInfo.new(TWEEN_TIME),
			{
				Size = Window.Minimized
					and UDim2.fromOffset(WINDOW_WIDTH, MIN_HEIGHT)
					or UDim2.fromOffset(WINDOW_WIDTH, WINDOW_HEIGHT)
			}
		):Play()
	end

	Min.MouseButton1Click:Connect(function()
		Window:Toggle()
	end)

	MakeDraggable(Main, TopBar)

	table.insert(Library.Windows, Window)
	UpdatePositions()

	return Window
end

return Library
